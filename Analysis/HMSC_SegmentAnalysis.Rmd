---
title: "HMSC Shoreline Segments"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r}
library(tidyverse)
library(cowplot)
library(Hmsc)

#Import data
long <- read_csv("../data/kelp_comparisons/Segment_All_LongCombined.csv")

distance <- read_csv("../data/kelp_comparisons/BarkleySoundAllData_Distance.csv")

distance2 <- tibble(Segment = distance$Segment, Dist = distance$NEAR_DIST_KM)

long2 <- left_join(long, distance2, by = "Segment")

#Remove NAs
long2 <- long2 %>% drop_na()
long2$Segment <- as.factor(long2$Segment)

##Set MCMC parameters
###Set test.run = TRUE when testing code, then FALSEwhen running code
nChains = 2
test.run = TRUE
if (test.run){
thin = 1
samples = 10
transient = 5
verbose = 5
} else {
thin = 5
samples = 1000
transient = 500*thin
verbose = 500*thin
}

XData = tibble(Year = long2$Year %>% as.factor(), Dist = long2$Dist) %>% as.data.frame()
XFormula = ~Year + Dist + Year*Dist
Y = matrix(long2$Kelp_bin)
studyDesign = tibble(Segment = long2$Segment) %>% as.data.frame()
rL = HmscRandomLevel(units = levels(long2$Segment))

m = Hmsc(Y = Y, XFormula = XFormula, XData = XData, studyDesign = studyDesign, ranLevels = list(Segment = rL), distr = "probit")

m = sampleMcmc(m, thin = thin, samples = samples, transient = transient,
nChains = nChains, verbose = verbose)


mpost = convertToCodaObject(m)
effectiveSize(mpost$Beta)

gelman.diag(mpost$Beta, multivariate=FALSE)$psrf

preds = computePredictedValues(m)
evaluateModelFit(hM = m, predY = preds)

Gradient = constructGradient(m, focalVariable = "Year")
predY = predict(m, Gradient = Gradient)
plotGradient(m, Gradient, pred = predY, measure = "Y", showData = TRUE)

```
